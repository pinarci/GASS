<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Dashboard - General AI Safety Systems</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      font-size: 1.5rem;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info {
      text-align: right;
    }

    .user-name {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .user-role {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    /* Main container */
    .main-container {
      padding: 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Card styles */
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      color: white;
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .card-icon {
      font-size: 2rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    /* Student status card */
    .student-status {
      grid-column: 1 / -1;
      text-align: center;
    }

    .student-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .student-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .student-details {
      text-align: left;
    }

    .student-name {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .student-class {
      font-size: 1.1rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-weight: 600;
      font-size: 1.1rem;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-on-bus {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
    }

    .status-at-school {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .status-at-home {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }

    .status-just-off-bus {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      animation: pulse 2s ease-in-out infinite;
    }



    /* Location map card */
    .location-map {
      position: relative;
      grid-column: 1 / -1; /* Make it span both columns */
    }

    .map-display {
      width: 100%;
      height: 300px;
      border-radius: 12px;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .map-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
    }

    .location-info {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .location-text {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .location-coords {
      opacity: 0.8;
      font-size: 0.8rem;
    }

    /* Recent activities */
    .activities {
      grid-column: 1 / -1;
    }

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .activity-item {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
    }

    .activity-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateX(5px);
    }

    .activity-icon {
      font-size: 1.5rem;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .activity-icon.boarding {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    }

    .activity-icon.arrival {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .activity-icon.departure {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .activity-icon.getting-off {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .activity-time {
      opacity: 0.8;
      font-size: 0.9rem;
    }

    /* Navigation tabs */
    .nav-tabs {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 0.5rem;
      display: flex;
      gap: 0.5rem;
      z-index: 100;
    }

    .nav-tab {
      padding: 0.75rem 1.5rem;
      border-radius: 20px;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .nav-tab.active,
    .nav-tab:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: translateY(-2px);
    }

    /* Responsive design */
    @media (max-width: 1024px) {
      .main-container {
        grid-template-columns: 1fr;
        padding: 1rem;
      }

      .header {
        padding: 1rem;
      }

      .student-info {
        flex-direction: column;
        text-align: center;
      }

      .student-details {
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .nav-tabs {
        bottom: 1rem;
        left: 1rem;
        right: 1rem;
        transform: none;
      }

      .nav-tab {
        flex: 1;
        justify-content: center;
        padding: 0.75rem 0.5rem;
      }
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .floating-notification {
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">üë®‚Äçüë©‚Äçüëß</div>
      <div class="header-title">Parent Dashboard</div>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div class="user-name">{{ user_name }}</div>
        <div class="user-role">{{ current_user.role.capitalize() }}</div>
      </div>
      <a href="/login" class="logout-btn">Logout</a>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Student Status -->
    <div class="card student-status">
      <div class="card-header">
        <div class="card-icon">{% if student.gender == 'F' %}üëß{% else %}üë¶{% endif %}</div>
        <div class="card-title">Student Status</div>
      </div>
      <div class="student-info">
        <div class="student-avatar">{% if student.gender == 'F' %}üëß{% else %}üë¶{% endif %}</div>
        <div class="student-details">
          <div class="student-name">{{ student.name }}</div>
          <div class="student-class">Class {{ student.class }}</div>
          <div class="status-indicator {{ student.status_class }}">
            {% if student.status == 'At Home' %}üè†{% elif student.status == 'In the bus' %}üöå{% else %}üè´{% endif %} {{ student.status }}
          </div>
        </div>
      </div>
    </div>



    <!-- Location Map -->
    <div class="card location-map">
      <div class="card-header">
        <div class="card-icon">üó∫Ô∏è</div>
        <div class="card-title">Location Tracking</div>
      </div>
      <div class="map-display">
        <iframe 
          class="map-iframe"
          src="https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY&center=41.0082,28.9784&zoom=15&maptype=roadmap"
          allowfullscreen>
        </iframe>
        <div class="location-info">
          <div class="location-text">üìç Atat√ºrk Caddesi, No: 45</div>
          <div class="location-coords">41.0082¬∞ K, 28.9784¬∞ D</div>
        </div>
      </div>
    </div>

    <!-- Recent Activities -->
    <div class="card activities">
      <div class="card-header">
        <div class="card-icon">üìã</div>
        <div class="card-title">Recent Activities</div>
      </div>
      <div class="activity-list">
        <div class="activity-item">
          <div class="activity-icon boarding">üöå</div>
          <div class="activity-content">
            <div class="activity-text">{{ student.name.split()[0] }} boarded the bus</div>
            <div class="activity-time">Today 07:45</div>
          </div>
        </div>
        <div class="activity-item">
          <div class="activity-icon arrival">üè´</div>
          <div class="activity-content">
            <div class="activity-text">Arrived safely at school</div>
            <div class="activity-time">Today 08:15</div>
          </div>
        </div>
        <div class="activity-item">
          <div class="activity-icon departure">üöå</div>
          <div class="activity-content">
            <div class="activity-text">Left school</div>
            <div class="activity-time">Yesterday 15:30</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="nav-tabs">
    <a href="#" class="nav-tab active">
      <span>üè†</span>
      <span>Home</span>
    </a>
    <a href="/messages" class="nav-tab">
      <span>üí¨</span>
      <span>Messages</span>
    </a>
  </div>

  <!-- Floating Notification -->
  <div class="floating-notification" id="notification" style="display: none;">
    <strong>üöå Bus Notification:</strong> Your child just got on the bus
  </div>
  
  <!-- Hidden data for JavaScript -->
  <div id="initial-attendance" style="display: none;">{{ student.attendance }}</div>

  <script>
    // Track previous attendance status to detect changes
    let previousAttendance = document.getElementById('initial-attendance').textContent.trim() === 'True';
    let isFirstCheck = true; // Flag to prevent notification on first API call
    let temporaryOffBusStatus = false; // Flag for temporary "just got off" status
    let offBusTimeout = null; // Timeout for reverting status
    
    // Dynamic status checking - polls server every 5 seconds
    function checkStudentStatus() {
      fetch('/api/student-status')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const statusElement = document.querySelector('.status-indicator');
            const studentNameElement = document.querySelector('.student-name');
            const studentClassElement = document.querySelector('.student-class');
            
            // Check if attendance changed from false to true (got on the bus)
            if (!isFirstCheck && !previousAttendance && data.student.attendance) {
              showBusNotification(data.student.name, 'boarded');
            }
            
            // Check if attendance changed from true to false (got off the bus)
            if (!isFirstCheck && previousAttendance && !data.student.attendance) {
              showOffBusNotification(data.student.name);
            }
            
            // Update previous attendance status
            previousAttendance = data.student.attendance;
            isFirstCheck = false; // After first check, allow notifications
            
            // Update status indicator (consider temporary status)
            let displayStatus = data.student.status;
            let displayClass = data.student.status_class;
            let displayIcon = data.student.status_icon;
            
            // If we have a temporary "just got off" status, override the display
            if (temporaryOffBusStatus && !data.student.attendance) {
              displayStatus = 'Just got off the bus';
              displayClass = 'status-just-off-bus';
              displayIcon = 'üèÉ‚Äç‚ôÇÔ∏è';
            }
            
            statusElement.className = `status-indicator ${displayClass}`;
            statusElement.innerHTML = `${displayIcon} ${displayStatus}`;
            
            // Update student info if changed
            studentNameElement.textContent = data.student.name;
            studentClassElement.textContent = `Class ${data.student.class}`;
            
            console.log('Status updated:', displayStatus);
          } else {
            console.error('Failed to fetch student status:', data.error);
          }
        })
        .catch(error => {
          console.error('Error fetching student status:', error);
        });
    }

    // Show notification when child gets on the bus
    function showBusNotification(studentName, type) {
      const notification = document.getElementById('notification');
      const firstName = studentName.split(' ')[0];
      notification.innerHTML = `<strong>üöå Bus Notification:</strong> Your child ${firstName} just got on the bus`;
      notification.style.display = 'block';

      // Add to activities list permanently and save to database
      const activityText = `${firstName} boarded the bus`;
      addActivityToList(firstName, 'boarded', activityText, true);

      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    // Show notification when child gets off the bus
    function showOffBusNotification(studentName) {
      const notification = document.getElementById('notification');
      const firstName = studentName.split(' ')[0];
      notification.innerHTML = `<strong>üèÉ‚Äç‚ôÇÔ∏è Bus Notification:</strong> Your child ${firstName} just got off the bus`;
      notification.style.display = 'block';

      // Set temporary status flag
      temporaryOffBusStatus = true;
      
      // Clear any existing timeout
      if (offBusTimeout) {
        clearTimeout(offBusTimeout);
      }
      
      // Revert to normal status after 30 seconds (will show "At Home" after page refresh)
      offBusTimeout = setTimeout(() => {
        temporaryOffBusStatus = false;
        // Force a status update to revert to normal "At Home"
        checkStudentStatus();
      }, 30000); // 30 seconds

      // Add to activities list permanently and save to database
      const activityText = `${firstName} got off the bus`;
      addActivityToList(firstName, 'got_off', activityText, true);

      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    // Add new activity to the activities list
    function addActivityToList(studentName, activityType, activityText = null, saveToDb = false, timestamp = null) {
      const activityList = document.querySelector('.activity-list');
      
      // Use provided timestamp or current time
      let timeString, dateString;
      if (timestamp) {
        const activityDate = new Date(timestamp);
        timeString = activityDate.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        const today = new Date();
        const isToday = activityDate.toDateString() === today.toDateString();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const isYesterday = activityDate.toDateString() === yesterday.toDateString();
        
        if (isToday) {
          dateString = 'Today';
        } else if (isYesterday) {
          dateString = 'Yesterday';
        } else {
          dateString = activityDate.toLocaleDateString('en-US');
        }
      } else {
        const now = new Date();
        timeString = now.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        dateString = 'Today';
      }

      // Create new activity item
      const newActivity = document.createElement('div');
      newActivity.className = 'activity-item';
      newActivity.style.opacity = '0';
      newActivity.style.transform = 'translateX(-20px)';

      let finalActivityText, iconClass, iconEmoji;
      
      if (activityText) {
        finalActivityText = activityText;
      } else if (activityType === 'boarded') {
        finalActivityText = `${studentName} boarded the bus`;
      } else if (activityType === 'got_off') {
        finalActivityText = `${studentName} got off the bus`;
      }
      
      if (activityType === 'boarded') {
        iconClass = 'boarding';
        iconEmoji = 'üöå';
      } else if (activityType === 'got_off') {
        iconClass = 'getting-off';
        iconEmoji = 'üèÉ‚Äç‚ôÇÔ∏è';
      }

      newActivity.innerHTML = `
        <div class="activity-icon ${iconClass}">${iconEmoji}</div>
        <div class="activity-content">
          <div class="activity-text">${finalActivityText}</div>
          <div class="activity-time">${dateString} ${timeString}</div>
        </div>
      `;

      // Insert at the beginning of the list
      activityList.insertBefore(newActivity, activityList.firstChild);

      // Animate in
      setTimeout(() => {
        newActivity.style.transition = 'all 0.3s ease';
        newActivity.style.opacity = '1';
        newActivity.style.transform = 'translateX(0)';
      }, 100);

      // Save to database if requested
      if (saveToDb) {
        fetch('/api/save-activity', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            student_name: studentName,
            activity_type: activityType,
            activity_text: finalActivityText
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('Activity saved to database');
          } else {
            console.error('Failed to save activity:', data.error);
          }
        })
        .catch(error => {
          console.error('Error saving activity:', error);
        });
      }

      // Limit to maximum 5 activities
      const activities = activityList.querySelectorAll('.activity-item');
      if (activities.length > 5) {
        activities[activities.length - 1].remove();
      }
    }

    // Load activities from database on page load
    function loadActivities() {
      fetch('/api/get-activities')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.activities.length > 0) {
            // Clear existing static activities
            const activityList = document.querySelector('.activity-list');
            activityList.innerHTML = '';
            
            // Add activities from database in reverse order since they come latest first
            // but addActivityToList() inserts at the beginning
            data.activities.reverse().forEach(activity => {
              addActivityToList(
                activity.student_name, 
                activity.activity_type, 
                activity.activity_text, 
                false, // Don't save to DB again
                activity.timestamp
              );
            });
          }
        })
        .catch(error => {
          console.error('Error loading activities:', error);
        });
    }

    // Load activities from database on page load
    loadActivities();

    // Start dynamic status checking every 5 seconds
    setInterval(checkStudentStatus, 5000);

    // Map functionality
    let currentLocation = {
      lat: 41.0082,
      lng: 28.9784,
      address: "Atat√ºrk Caddesi, No: 45"
    };

    // Update map with new coordinates
    function updateMapLocation(lat, lng, address = null) {
      const mapIframe = document.querySelector('.map-iframe');
      const locationText = document.querySelector('.location-text');
      const locationCoords = document.querySelector('.location-coords');
      
      // Update iframe src with new coordinates
      mapIframe.src = `https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY&center=${lat},${lng}&zoom=15&maptype=roadmap`;
      
      // Update location info
      if (address) {
        locationText.textContent = `üìç ${address}`;
      }
      locationCoords.textContent = `${lat.toFixed(4)}¬∞ K, ${lng.toFixed(4)}¬∞ D`;
      
      currentLocation = { lat, lng, address: address || currentLocation.address };
    }

    // Simulate bus movement (for demonstration)
    function simulateBusMovement() {
      // This would normally come from your real bus tracking API
      // For now, we'll use the static coordinates
      const locations = [
        { lat: 41.0082, lng: 28.9784, address: "Atat√ºrk Caddesi, No: 45" },
        { lat: 41.0085, lng: 28.9790, address: "Taksim Meydanƒ±" },
        { lat: 41.0090, lng: 28.9795, address: "ƒ∞stiklal Caddesi" }
      ];
      
      // You can enable this for demo purposes:
      // let locationIndex = 0;
      // setInterval(() => {
      //   updateMapLocation(locations[locationIndex].lat, locations[locationIndex].lng, locations[locationIndex].address);
      //   locationIndex = (locationIndex + 1) % locations.length;
      // }, 10000); // Update every 10 seconds
    }

    // Initialize map
    simulateBusMovement();

    // No automatic periodic notifications

    // Add some interactivity to cards
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', function() {
        this.style.transform = 'translateY(-5px) scale(1.02)';
        setTimeout(() => {
          this.style.transform = 'translateY(-5px)';
        }, 200);
      });
    });

    // Real-time clock update
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('en-US');
      // You can add this to display current time somewhere if needed
    }

    setInterval(updateTime, 1000);
  </script>
</body>
</html>